<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" href="image/gps.ico">
  <title>ä½ç½®é€£å‹•å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

    :root {
      --bg-color: #121212;
      --primary-color: #1e88e5;
      --primary-hover: #1565c0;
      --text-color: #e0e0e0;
      --card-bg: #1f1f1f;
      --border-radius: 12px;
    }

    * { box-sizing: border-box; }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Roboto Mono', monospace;
      margin: 0;
      padding: 2rem 1rem;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      /* é‡è¦: ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚„èª¤é¸æŠã‚’é˜²ã */
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    main { max-width: 480px; width: 100%; }

    h1 {
      font-weight: 700; font-size: 1.8rem; margin-bottom: 1rem;
      text-align: center; color: var(--primary-color);
    }

    .card {
      background-color: var(--card-bg); border-radius: var(--border-radius);
      padding: 1.5rem 2rem; margin-bottom: 1.5rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.6);
    }
    
    .hidden { display: none !important; }

    input[type="number"], input[type="text"] {
      width: 100%; padding: 0.8rem; font-size: 1rem; border-radius: 8px; border: none;
      background-color: #2c2c2c; color: var(--text-color); margin-bottom: 1rem;
      user-select: text; -webkit-user-select: text; /* å…¥åŠ›æ¬„ã¯é¸æŠå¯èƒ½ã« */
    }

    button {
      padding: 0.8rem 1.2rem; font-size: 1rem; font-weight: 600; color: white;
      background-color: var(--primary-color); border: none; border-radius: 32px;
      cursor: pointer; margin-right: 0.5rem; margin-bottom: 0.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    button:hover { background-color: var(--primary-hover); }

    /* ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
    #btn-pocket-mode {
      width: 100%; background-color: #00897b; display: flex;
      align-items: center; justify-content: center; gap: 10px; margin-bottom: 1.5rem;
    }

    /* é»’ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #pocket-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #000000; z-index: 9999;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #444; text-align: center;
    }

    #distance-info {
      text-align: center; font-size: 1.1rem; margin-bottom: 1rem;
      color: #aaa; background: #252525; padding: 10px; border-radius: 8px;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
    #checklist ul { list-style: none; padding: 0; margin: 0; }
    #checklist li {
      background-color: #2a2a2a; border-radius: 8px; padding: 0.8rem 1rem;
      margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.8rem;
    }
    #checklist input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--primary-color); }
    .list-text { flex-grow: 1; color: var(--text-color); font-size: 1rem; }
    .flex-row { display: flex; gap: 5px; }
    #new-item { flex-grow: 1; margin-bottom: 0; }
  </style>
</head>
<body>

  <div id="pocket-overlay" class="hidden">
    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ”’</div>
    <p style="font-size: 1.2rem; color: #666;">ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ç¨¼åƒä¸­</p>
    <p id="overlay-status" style="font-size: 0.9rem; margin-top: 20px; color: #00897b;">è¨ˆæ¸¬ä¸­...</p>
    <p style="margin-top: 60px; font-size: 0.8rem; color: #333;">
      ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ— ã¾ãŸã¯<br>2ç§’é•·æŠ¼ã—ã§è§£é™¤
    </p>
  </div>

  <main>
    <h1>ä½ç½®é€£å‹•å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</h1>

    <button id="btn-pocket-mode">
      <span>ğŸš€ å‡ºç™ºãƒ¢ãƒ¼ãƒ‰ (ç”»é¢å¸¸æ™‚ç‚¹ç¯)</span>
    </button>

    <div id="distance-info">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>

    <section id="checklist" class="card">
      <h2>å¿˜ã‚Œç‰©ãƒªã‚¹ãƒˆ</h2>
      <ul id="items-list"></ul>
      <div class="flex-row" style="margin-top: 1rem;">
        <input type="text" id="new-item" placeholder="ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ " />
        <button id="btn-add-item">è¿½åŠ </button>
      </div>
    </section>

    <button id="btn-toggle-setup" style="background-color: #444; font-size: 0.8rem; margin: 0 auto 1.5rem auto; display: block;">å ´æ‰€ã®è¨­å®šã‚’å¤‰æ›´</button>
    
    <section id="setup-section" class="card hidden">
      <label>è‡ªå®…ã®ç·¯åº¦<input type="number" step="0.000001" id="home-lat" /></label>
      <label>è‡ªå®…ã®çµŒåº¦<input type="number" step="0.000001" id="home-lng" /></label>
      <label>é€šçŸ¥ã™ã‚‹è·é›¢ (m)<input type="number" id="meters-input" value="20" /></label>
      <button id="btn-get-location">ç¾åœ¨åœ°ã‚’å–å¾—</button>
      <button id="btn-save-home">è¨­å®šã‚’ä¿å­˜</button>
    </section>
  </main>

<script>
// --- Cookieåˆ¶å¾¡ ---
function setCookie(n,v){const d=new Date();d.setTime(d.getTime()+(365*24*60*60*1000));document.cookie=`${n}=${encodeURIComponent(v)};expires=${d.toUTCString()};path=/;SameSite=Strict`;}
function getCookie(n){const eq=n+"=";const ca=document.cookie.split(';');for(let i=0;i<ca.length;i++){let c=ca[i].trim();if(c.indexOf(eq)===0)return decodeURIComponent(c.substring(eq.length,c.length));}return "";}

// --- DOMè¦ç´  ---
const els = {
  hLat: document.getElementById('home-lat'),
  hLng: document.getElementById('home-lng'),
  meter: document.getElementById('meters-input'),
  dist: document.getElementById('distance-info'),
  list: document.getElementById('items-list'),
  input: document.getElementById('new-item'),
  setup: document.getElementById('setup-section'),
  pocketBtn: document.getElementById('btn-pocket-mode'),
  overlay: document.getElementById('pocket-overlay'),
  overlayStatus: document.getElementById('overlay-status')
};

// --- Wake Lock (ç”»é¢å¸¸æ™‚ç‚¹ç¯) ---
let wakeLock = null;
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('Wake Lock active');
      wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
    } catch (err) {
      console.error(err);
    }
  }
}

// --- è·é›¢è¨ˆç®— ---
function getDistance(lat1, lng1, lat2, lng2) {
  const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

// --- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæç”» ---
function renderChecklist() {
  const items = JSON.parse(getCookie('checklist') || "[]");
  els.list.innerHTML = '';
  items.forEach((txt, i) => {
    const li=document.createElement('li'), cb=document.createElement('input'), lbl=document.createElement('label');
    cb.type='checkbox'; cb.id=`item-${i}`;
    lbl.className='list-text'; lbl.htmlFor=`item-${i}`; lbl.textContent=txt;
    cb.onchange=()=>{ 
      if(cb.checked) setTimeout(()=>{
        setCookie('checklist', JSON.stringify(items.filter((_,idx)=>idx!==i))); renderChecklist();
      },250);
    };
    li.append(cb, lbl); els.list.append(li);
  });
}

// --- ä½ç½®è¨ˆæ¸¬ & é€šçŸ¥ ---
let lastNotifyTime = 0;
function checkLocation() {
  const hLat=parseFloat(getCookie('homeLat')), hLng=parseFloat(getCookie('homeLng')), th=parseFloat(getCookie('threshold'))||20;
  if(isNaN(hLat)){ els.dist.textContent="è‡ªå®…æœªè¨­å®š"; return; }

  navigator.geolocation.getCurrentPosition(pos => {
    const dist = getDistance(hLat, hLng, pos.coords.latitude, pos.coords.longitude);
    const msg = `ç¾åœ¨ï¼šè‡ªå®…ã‹ã‚‰ ${dist.toFixed(1)}m`;
    els.dist.textContent = msg;
    els.overlayStatus.textContent = msg; // é»’ç”»é¢ã«ã‚‚çŠ¶æ…‹ã‚’è¡¨ç¤º

    if(dist > th) {
      const now = Date.now();
      if(now - lastNotifyTime > 180000) { // 3åˆ†é–“éš”
        lastNotifyTime = now;
        if(Notification.permission === 'granted' && 'serviceWorker' in navigator) {
          navigator.serviceWorker.ready.then(reg => {
            reg.showNotification("å¿˜ã‚Œç‰©ã¯ãªã„ã§ã™ã‹ï¼Ÿ", { 
              body: `è‡ªå®…ã‹ã‚‰ ${dist.toFixed(0)}m é›¢ã‚Œã¾ã—ãŸã€‚ãƒªã‚¹ãƒˆã‚’ç¢ºèªï¼`,
              tag: 'forget-check',
              icon: 'image/gps.ico',
              vibrate: [500, 200, 500] // é•·ã‚ã®ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            });
          });
        }
      }
    }
  }, null, { enableHighAccuracy: true });
}

// --- ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰æ“ä½œ (ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ— & é•·æŠ¼ã—ä¿®æ­£ç‰ˆ) ---
els.pocketBtn.addEventListener('click', async () => {
  if (Notification.permission !== 'granted') await Notification.requestPermission();
  els.overlay.classList.remove('hidden'); // é»’ç”»é¢è¡¨ç¤º
  requestWakeLock(); // å¸¸æ™‚ç‚¹ç¯é–‹å§‹
});

let lastTap = 0;
let pressTimer = null;

// ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®š (touchendä½¿ç”¨)
els.overlay.addEventListener('touchend', (e) => {
  e.preventDefault(); // ã‚ºãƒ¼ãƒ ç­‰ã‚’ç„¡åŠ¹åŒ–
  if (pressTimer) clearTimeout(pressTimer); // é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«

  const cur = new Date().getTime();
  if (cur - lastTap < 500) { // 0.5ç§’ä»¥å†…ãªã‚‰è§£é™¤
    unlockPocketMode();
  }
  lastTap = cur;
});

// é•·æŠ¼ã—åˆ¤å®š (touchstartä½¿ç”¨)
els.overlay.addEventListener('touchstart', (e) => {
  pressTimer = setTimeout(() => {
    unlockPocketMode();
  }, 2000); // 2ç§’é•·æŠ¼ã—
}, {passive: false});

function unlockPocketMode() {
  els.overlay.classList.add('hidden');
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
  if (navigator.vibrate) navigator.vibrate(100); // è§£é™¤åˆå›³
}

// --- ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ ---
document.getElementById('btn-get-location').onclick = () => navigator.geolocation.getCurrentPosition(p=>{
  els.hLat.value=p.coords.latitude.toFixed(6); els.hLng.value=p.coords.longitude.toFixed(6);
});
document.getElementById('btn-save-home').onclick = () => {
  setCookie('homeLat',els.hLat.value); setCookie('homeLng',els.hLng.value); setCookie('threshold',els.meter.value);
  alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ"); els.setup.classList.add('hidden');
};
document.getElementById('btn-add-item').onclick = () => {
  const v=els.input.value.trim(); if(!v)return;
  const a=JSON.parse(getCookie('checklist')||"[]"); a.push(v);
  setCookie('checklist',JSON.stringify(a)); els.input.value=''; renderChecklist();
};
document.getElementById('btn-toggle-setup').onclick=()=>els.setup.classList.toggle('hidden');

// --- åˆæœŸåŒ– ---
window.onload = () => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Ready')).catch(console.error);
  }
  
  els.hLat.value = getCookie('homeLat');
  els.hLng.value = getCookie('homeLng');
  els.meter.value = getCookie('threshold') || 20;
  
  if(!getCookie('homeLat')) els.setup.classList.remove('hidden');
  
  renderChecklist();
  checkLocation();
  setInterval(checkLocation, 10000); // 10ç§’ã”ã¨ã«æ›´æ–°

  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚ã«WakeLockã‚’å†å–å¾—
  document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && !els.overlay.classList.contains('hidden')) {
      await requestWakeLock();
    }
  });
};
</script>
</body>
</html>