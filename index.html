<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="image/gps.ico">
  <title>ä½ç½®é€£å‹•å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

    :root {
      --bg-color: #121212;
      --primary-color: #1e88e5;
      --primary-hover: #1565c0;
      --text-color: #e0e0e0;
      --card-bg: #1f1f1f;
    }

    * { box-sizing: border-box; }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Roboto Mono', monospace;
      margin: 0;
      padding: 2rem 1rem;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      /* èª¤æ“ä½œé˜²æ­¢ã®ãŸã‚é¸æŠä¸å¯ã« */
      user-select: none; 
    }

    main { max-width: 480px; width: 100%; }

    h1 {
      font-weight: 700;
      font-size: 1.8rem;
      margin-bottom: 1rem;
      text-align: center;
      color: var(--primary-color);
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem 2rem;
      box-shadow: 0 6px 12px rgba(0,0,0,0.6);
      margin-bottom: 1.5rem;
    }
    
    .hidden { display: none; }

    label { display: block; font-size: 0.9rem; margin-bottom: 0.3rem; color: #bbb; }
    
    input[type="number"], input[type="text"] {
      width: 100%; padding: 0.6rem; font-size: 1rem; border-radius: 8px; border: none;
      background-color: #2c2c2c; color: var(--text-color); margin-bottom: 1rem;
      user-select: text; /* å…¥åŠ›æ¬„ã¯é¸æŠå¯èƒ½ã« */
    }

    button {
      padding: 0.65rem 1.2rem; font-size: 1rem; font-weight: 600; color: white;
      background-color: var(--primary-color); border: none; border-radius: 32px;
      cursor: pointer; transition: 0.3s; margin-right: 0.5rem; margin-bottom: 0.5rem;
    }
    button:hover { background-color: var(--primary-hover); }

    /* ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ãƒœã‚¿ãƒ³ */
    #btn-pocket-mode {
      width: 100%;
      background-color: #00897b;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    /* ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã®é»’ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #pocket-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: black;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #333;
      text-align: center;
    }

    #distance-info {
      text-align: center; font-size: 1.1rem; margin-bottom: 1rem;
      color: #aaa; background: #252525; padding: 10px; border-radius: 8px;
    }

    #checklist ul { list-style: none; padding: 0; margin: 0; }
    #checklist li {
      background-color: #2a2a2a; border-radius: 8px; padding: 0.8rem 1rem;
      margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.8rem;
    }
    #checklist input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary-color); }
    .list-text { flex-grow: 1; color: var(--text-color); font-size: 1rem; }
    .flex-row { display: flex; gap: 5px; }
    #new-item { flex-grow: 1; }
  </style>
</head>
<body>

  <div id="pocket-overlay" class="hidden">
    <div style="font-size: 3rem;">ğŸ”’</div>
    <p>ãƒã‚±ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ç¨¼åƒä¸­</p>
    <p id="overlay-status" style="font-size: 0.8rem; margin-top: 20px;">è¨ˆæ¸¬ä¸­...</p>
    <p style="margin-top: 50px; color: #555;">ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§è§£é™¤</p>
  </div>

  <main>
    <h1>ä½ç½®é€£å‹•å¿˜ã‚Œç‰©ãƒã‚§ãƒƒã‚¯</h1>

    <button id="btn-pocket-mode">
      <span>ğŸš€ å‡ºç™ºãƒ¢ãƒ¼ãƒ‰ (ç”»é¢å¸¸æ™‚ç‚¹ç¯)</span>
    </button>

    <div id="distance-info">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>

    <section id="checklist" class="card">
      <h2>å¿˜ã‚Œç‰©ãƒªã‚¹ãƒˆ</h2>
      <ul id="items-list"></ul>
      <div class="flex-row" style="margin-top: 1rem;">
        <input type="text" id="new-item" placeholder="ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ " />
        <button id="btn-add-item">è¿½åŠ </button>
      </div>
    </section>

    <button id="btn-toggle-setup" style="background-color: #444; font-size: 0.8rem; margin: 0 auto; display: block;">è¨­å®šå¤‰æ›´</button>
    
    <section id="setup-section" class="card hidden" style="margin-top: 1rem;">
      <label>è‡ªå®…ã®ç·¯åº¦<input type="number" step="0.000001" id="home-lat" /></label>
      <label>è‡ªå®…ã®çµŒåº¦<input type="number" step="0.000001" id="home-lng" /></label>
      <label>é€šçŸ¥è·é›¢(m)<input type="number" id="meters-input" value="20" /></label>
      <button id="btn-get-location">ç¾åœ¨åœ°å–å¾—</button>
      <button id="btn-save-home">ä¿å­˜</button>
    </section>
  </main>

<script>
// --- CookieUtil ---
function setCookie(n,v){const d=new Date();d.setTime(d.getTime()+(365*24*60*60*1000));document.cookie=`${n}=${encodeURIComponent(v)};expires=${d.toUTCString()};path=/;SameSite=Strict`;}
function getCookie(n){const eq=n+"=";const ca=document.cookie.split(';');for(let i=0;i<ca.length;i++){let c=ca[i].trim();if(c.indexOf(eq)===0)return decodeURIComponent(c.substring(eq.length,c.length));}return "";}

// --- DOM ---
const els = {
  hLat: document.getElementById('home-lat'),
  hLng: document.getElementById('home-lng'),
  meter: document.getElementById('meters-input'),
  dist: document.getElementById('distance-info'),
  list: document.getElementById('items-list'),
  input: document.getElementById('new-item'),
  setup: document.getElementById('setup-section'),
  pocketBtn: document.getElementById('btn-pocket-mode'),
  overlay: document.getElementById('pocket-overlay'),
  overlayStatus: document.getElementById('overlay-status')
};

// --- Haversine ---
function getDistance(lat1, lng1, lat2, lng2) {
  const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

// --- Checklist Logic ---
function renderList() {
  const items = JSON.parse(getCookie('checklist') || "[]");
  els.list.innerHTML = '';
  items.forEach((txt, i) => {
    const li=document.createElement('li'), cb=document.createElement('input'), lbl=document.createElement('label');
    cb.type='checkbox'; cb.id=`i-${i}`;
    lbl.className='list-text'; lbl.htmlFor=`i-${i}`; lbl.textContent=txt;
    cb.onchange=()=>{ 
      if(cb.checked) setTimeout(()=>{
        setCookie('checklist', JSON.stringify(items.filter((_,idx)=>idx!==i))); renderList();
      },250);
    };
    li.append(cb, lbl); els.list.append(li);
  });
}

// --- Wake Lock (ç”»é¢å¸¸æ™‚ç‚¹ç¯) ---
let wakeLock = null;
async function requestWakeLock() {
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    console.log('Wake Lock active');
    wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
  } catch (err) {
    console.error(`${err.name}, ${err.message}`);
    alert("å¸¸æ™‚ç‚¹ç¯æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
}

// --- Location & Notify ---
let lastNotify = 0;
function checkLocation() {
  const hLat=parseFloat(getCookie('homeLat')), hLng=parseFloat(getCookie('homeLng')), th=parseFloat(getCookie('threshold'))||20;
  if(isNaN(hLat)){ els.dist.textContent="è‡ªå®…æœªè¨­å®š"; return; }

  navigator.geolocation.getCurrentPosition(pos => {
    const dist = getDistance(hLat, hLng, pos.coords.latitude, pos.coords.longitude);
    const msg = `è‡ªå®…ã‹ã‚‰ ${dist.toFixed(1)}m`;
    els.dist.textContent = msg;
    els.overlayStatus.textContent = msg; // é»’ç”»é¢ã«ã‚‚è¡¨ç¤º

    if(dist > th) {
      const now = Date.now();
      if(now - lastNotify > 300000) { // 5åˆ†é–“éš”
        lastNotify = now;
        if(Notification.permission==='granted'){
          // Service WorkerçµŒç”±ã§é€šçŸ¥
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
              reg.showNotification("å‡ºç™ºã—ã¾ã—ãŸã‹ï¼Ÿ", {
                body: `${dist.toFixed(0)}m ç§»å‹•ã—ã¾ã—ãŸã€‚å¿˜ã‚Œç‰©ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ`,
                tag: 'check-alert',
                icon: 'image/gps.ico',
                vibrate: [500, 200, 500]
              });
            });
          }
        }
      }
    }
  }, err => {
    console.warn(err);
    els.dist.textContent = "GPSå–å¾—ã‚¨ãƒ©ãƒ¼";
  }, { enableHighAccuracy: true, maximumAge: 0 });
}

// --- Event Listeners ---
// å‡ºç™ºãƒ¢ãƒ¼ãƒ‰é–‹å§‹
els.pocketBtn.addEventListener('click', async () => {
  if (Notification.permission !== 'granted') await Notification.requestPermission();
  
  // ç”»é¢ã‚’é»’ãã™ã‚‹
  els.overlay.classList.remove('hidden');
  
  // å¸¸æ™‚ç‚¹ç¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  if ('wakeLock' in navigator) requestWakeLock();
  
  // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åŒ– (ä»»æ„)
  if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
});

// ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§è§£é™¤
let lastTap = 0;
els.overlay.addEventListener('click', (e) => {
  const cur = new Date().getTime();
  if (cur - lastTap < 300) {
    // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ¤œçŸ¥
    els.overlay.classList.add('hidden');
    if (wakeLock) wakeLock.release();
    if (document.exitFullscreen) document.exitFullscreen();
  }
  lastTap = cur;
});

// Setup Buttons
document.getElementById('btn-get-location').onclick = () => navigator.geolocation.getCurrentPosition(p=>{
  els.hLat.value=p.coords.latitude.toFixed(6); els.hLng.value=p.coords.longitude.toFixed(6);
});
document.getElementById('btn-save-home').onclick = () => {
  setCookie('homeLat',els.hLat.value); setCookie('homeLng',els.hLng.value); setCookie('threshold',els.meter.value);
  alert("ä¿å­˜ã—ã¾ã—ãŸ"); els.setup.classList.add('hidden');
};
document.getElementById('btn-add-item').onclick = () => {
  if(!els.input.value.trim())return;
  const arr=JSON.parse(getCookie('checklist')||"[]"); arr.push(els.input.value);
  setCookie('checklist',JSON.stringify(arr)); els.input.value=''; renderList();
};
document.getElementById('btn-toggle-setup').onclick=()=>els.setup.classList.toggle('hidden');

// --- Init ---
window.onload = () => {
  // SWç™»éŒ²
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
  
  // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
  els.hLat.value = getCookie('homeLat');
  els.hLng.value = getCookie('homeLng');
  els.meter.value = getCookie('threshold') || 20;
  if(!getCookie('homeLat')) els.setup.classList.remove('hidden');
  
  renderList();
  checkLocation();
  setInterval(checkLocation, 10000); // 10ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
  
  // ãƒšãƒ¼ã‚¸ãŒéš ã‚ŒãŸå¾Œã«æˆ»ã£ã¦ããŸã¨ãã«WakeLockãŒåˆ‡ã‚Œã¦ã„ã‚‹ã®ã§å†å–å¾—ã™ã‚‹å‡¦ç†
  document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
      await requestWakeLock();
    }
  });
};
</script>
</body>
</html>